generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [postgis]
}

// Main district table - consolidated from multiple tables for simpler queries
// Contains: core district info, Fullmind CRM data, education data, demographics, and user edits
model District {
  leaid              String   @id @db.VarChar(7)
  name               String   @db.VarChar(255)
  stateFips          String   @map("state_fips") @db.VarChar(2)
  stateAbbrev        String?  @map("state_abbrev") @db.VarChar(2)
  mtfcc              String?  @db.VarChar(5)
  sdtyp              String?  @db.VarChar(1)
  funcstat           String?  @default("E") @db.VarChar(1)
  lograde            String?  @db.VarChar(2)
  higrade            String?  @db.VarChar(2)
  enrollment         Int?
  urbanInstituteYear Int?     @map("urban_institute_year")
  phone              String?  @db.VarChar(20)
  streetLocation     String?  @map("street_location") @db.VarChar(255)
  cityLocation       String?  @map("city_location") @db.VarChar(100)
  stateLocation      String?  @map("state_location") @db.VarChar(2)
  zipLocation        String?  @map("zip_location") @db.VarChar(10)
  countyName         String?  @map("county_name") @db.VarChar(100)
  urbanCentricLocale Int?     @map("urban_centric_locale")
  numberOfSchools    Int?     @map("number_of_schools")
  specEdStudents     Int?     @map("spec_ed_students")
  ellStudents        Int?     @map("ell_students")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // ===== Fullmind CRM Data =====
  // Source: Fullmind CSV import via ETL
  accountName              String?  @map("account_name") @db.VarChar(255)
  salesExecutive           String?  @map("sales_executive") @db.VarChar(100)
  lmsid                    String?  @db.VarChar(50)
  // FY25 Sessions
  fy25SessionsRevenue      Decimal? @default(0) @map("fy25_sessions_revenue") @db.Decimal(15, 2)
  fy25SessionsTake         Decimal? @default(0) @map("fy25_sessions_take") @db.Decimal(15, 2)
  fy25SessionsCount        Int?     @default(0) @map("fy25_sessions_count")
  // FY26 Sessions
  fy26SessionsRevenue      Decimal? @default(0) @map("fy26_sessions_revenue") @db.Decimal(15, 2)
  fy26SessionsTake         Decimal? @default(0) @map("fy26_sessions_take") @db.Decimal(15, 2)
  fy26SessionsCount        Int?     @default(0) @map("fy26_sessions_count")
  // FY25 Bookings
  fy25ClosedWonOppCount    Int?     @default(0) @map("fy25_closed_won_opp_count")
  fy25ClosedWonNetBooking  Decimal? @default(0) @map("fy25_closed_won_net_booking") @db.Decimal(15, 2)
  fy25NetInvoicing         Decimal? @default(0) @map("fy25_net_invoicing") @db.Decimal(15, 2)
  // FY26 Bookings
  fy26ClosedWonOppCount    Int?     @default(0) @map("fy26_closed_won_opp_count")
  fy26ClosedWonNetBooking  Decimal? @default(0) @map("fy26_closed_won_net_booking") @db.Decimal(15, 2)
  fy26NetInvoicing         Decimal? @default(0) @map("fy26_net_invoicing") @db.Decimal(15, 2)
  // FY26 Pipeline
  fy26OpenPipelineOppCount Int?     @default(0) @map("fy26_open_pipeline_opp_count")
  fy26OpenPipeline         Decimal? @default(0) @map("fy26_open_pipeline") @db.Decimal(15, 2)
  fy26OpenPipelineWeighted Decimal? @default(0) @map("fy26_open_pipeline_weighted") @db.Decimal(15, 2)
  // FY27 Pipeline
  fy27OpenPipelineOppCount Int?     @default(0) @map("fy27_open_pipeline_opp_count")
  fy27OpenPipeline         Decimal? @default(0) @map("fy27_open_pipeline") @db.Decimal(15, 2)
  fy27OpenPipelineWeighted Decimal? @default(0) @map("fy27_open_pipeline_weighted") @db.Decimal(15, 2)
  // Computed flags
  isCustomer               Boolean? @default(false) @map("is_customer")
  hasOpenPipeline          Boolean? @default(false) @map("has_open_pipeline")

  // ===== Finance Data =====
  // Source: Urban Institute API (finance endpoint)
  totalRevenue        Decimal? @map("total_revenue") @db.Decimal(15, 2)
  federalRevenue      Decimal? @map("federal_revenue") @db.Decimal(15, 2)
  stateRevenue        Decimal? @map("state_revenue") @db.Decimal(15, 2)
  localRevenue        Decimal? @map("local_revenue") @db.Decimal(15, 2)
  totalExpenditure    Decimal? @map("total_expenditure") @db.Decimal(15, 2)
  expenditurePerPupil Decimal? @map("expenditure_per_pupil") @db.Decimal(12, 2)
  financeDataYear     Int?     @map("finance_data_year")

  // ===== Poverty Data =====
  // Source: Urban Institute API (SAIPE endpoint)
  childrenPovertyCount   Int?     @map("children_poverty_count")
  childrenPovertyPercent Decimal? @map("children_poverty_percent") @db.Decimal(5, 2)
  medianHouseholdIncome  Decimal? @map("median_household_income") @db.Decimal(12, 2)
  saipeDataYear          Int?     @map("saipe_data_year")

  // ===== Graduation Data =====
  // Source: Urban Institute API (graduation endpoint)
  graduationRateTotal  Decimal? @map("graduation_rate_total") @db.Decimal(5, 2)
  graduationRateMale   Decimal? @map("graduation_rate_male") @db.Decimal(5, 2)
  graduationRateFemale Decimal? @map("graduation_rate_female") @db.Decimal(5, 2)
  graduationDataYear   Int?     @map("graduation_data_year")

  // ===== Staffing & Salaries =====
  // Source: Urban Institute API (staff endpoint)
  salariesTotal                Decimal? @map("salaries_total") @db.Decimal(15, 2)
  salariesInstruction          Decimal? @map("salaries_instruction") @db.Decimal(15, 2)
  salariesTeachersRegular      Decimal? @map("salaries_teachers_regular") @db.Decimal(15, 2)
  salariesTeachersSpecialEd    Decimal? @map("salaries_teachers_special_ed") @db.Decimal(15, 2)
  salariesTeachersVocational   Decimal? @map("salaries_teachers_vocational") @db.Decimal(15, 2)
  salariesTeachersOther        Decimal? @map("salaries_teachers_other") @db.Decimal(15, 2)
  salariesSupportAdmin         Decimal? @map("salaries_support_admin") @db.Decimal(15, 2)
  salariesSupportInstructional Decimal? @map("salaries_support_instructional") @db.Decimal(15, 2)
  benefitsTotal                Decimal? @map("benefits_total") @db.Decimal(15, 2)
  teachersFte                  Decimal? @map("teachers_fte") @db.Decimal(10, 2)
  teachersElementaryFte        Decimal? @map("teachers_elementary_fte") @db.Decimal(10, 2)
  teachersSecondaryFte         Decimal? @map("teachers_secondary_fte") @db.Decimal(10, 2)
  adminFte                     Decimal? @map("admin_fte") @db.Decimal(10, 2)
  guidanceCounselorsFte        Decimal? @map("guidance_counselors_fte") @db.Decimal(10, 2)
  instructionalAidesFte        Decimal? @map("instructional_aides_fte") @db.Decimal(10, 2)
  supportStaffFte              Decimal? @map("support_staff_fte") @db.Decimal(10, 2)
  staffTotalFte                Decimal? @map("staff_total_fte") @db.Decimal(10, 2)
  staffDataYear                Int?     @map("staff_data_year")

  // ===== Absenteeism Data =====
  // Source: Urban Institute API (chronic absenteeism endpoint)
  chronicAbsenteeismCount Int?     @map("chronic_absenteeism_count")
  chronicAbsenteeismRate  Decimal? @map("chronic_absenteeism_rate") @db.Decimal(5, 2)
  absenteeismDataYear     Int?     @map("absenteeism_data_year")

  // ===== Demographics =====
  // Source: Urban Institute API (enrollment endpoint)
  enrollmentWhite           Int? @map("enrollment_white")
  enrollmentBlack           Int? @map("enrollment_black")
  enrollmentHispanic        Int? @map("enrollment_hispanic")
  enrollmentAsian           Int? @map("enrollment_asian")
  enrollmentAmericanIndian  Int? @map("enrollment_american_indian")
  enrollmentPacificIslander Int? @map("enrollment_pacific_islander")
  enrollmentTwoOrMore       Int? @map("enrollment_two_or_more")
  totalEnrollment           Int? @map("total_enrollment")
  demographicsDataYear      Int? @map("demographics_data_year")

  // ===== User Edits =====
  // Source: App users (shared across team)
  notes          String?
  owner          String?   @db.VarChar(100)
  notesUpdatedAt DateTime? @map("notes_updated_at")

  // ===== PostGIS Geometry (managed outside Prisma) =====
  geometry Unsupported("geometry(MultiPolygon, 4326)")?
  centroid Unsupported("geometry(Point, 4326)")?

  // ===== Relations =====
  state          State?                  @relation(fields: [stateFips], references: [fips])
  contacts       Contact[]
  districtTags   DistrictTag[]
  territoryPlans TerritoryPlanDistrict[]
  planActivities PlanActivity[]

  @@index([stateFips])
  @@index([isCustomer, hasOpenPipeline])
  @@index([stateAbbrev])
  @@index([stateAbbrev, isCustomer])
  @@index([stateAbbrev, hasOpenPipeline])
  @@index([salesExecutive])
  @@map("districts")
}

model Tag {
  id           Int           @id @default(autoincrement())
  name         String        @unique @db.VarChar(50)
  color        String        @db.VarChar(7)
  districtTags DistrictTag[]

  @@map("tags")
}

model DistrictTag {
  districtLeaid String   @map("district_leaid") @db.VarChar(7)
  tagId         Int      @map("tag_id")
  district      District @relation(fields: [districtLeaid], references: [leaid])
  tag           Tag      @relation(fields: [tagId], references: [id])

  @@id([districtLeaid, tagId])
  @@map("district_tags")
}

model Contact {
  id         Int                   @id @default(autoincrement())
  leaid      String                @db.VarChar(7)
  name       String                @db.VarChar(255)
  title      String?               @db.VarChar(100)
  email      String?               @db.VarChar(255)
  phone      String?               @db.VarChar(50)
  isPrimary  Boolean               @default(false) @map("is_primary")
  district   District              @relation(fields: [leaid], references: [leaid])
  activities PlanActivityContact[]

  @@index([leaid])
  @@map("contacts")
}

model UnmatchedAccount {
  id                 Int      @id @default(autoincrement())
  accountName        String   @map("account_name") @db.VarChar(255)
  salesExecutive     String?  @map("sales_executive") @db.VarChar(100)
  stateAbbrev        String   @map("state_abbrev") @db.VarChar(2)
  lmsid              String?  @db.VarChar(50)
  leaidRaw           String?  @map("leaid_raw") @db.VarChar(50)
  matchFailureReason String   @map("match_failure_reason") @db.VarChar(100)
  fy25NetInvoicing   Decimal  @default(0) @map("fy25_net_invoicing") @db.Decimal(15, 2)
  fy26NetInvoicing   Decimal  @default(0) @map("fy26_net_invoicing") @db.Decimal(15, 2)
  fy26OpenPipeline   Decimal  @default(0) @map("fy26_open_pipeline") @db.Decimal(15, 2)
  fy27OpenPipeline   Decimal  @default(0) @map("fy27_open_pipeline") @db.Decimal(15, 2)
  isCustomer         Boolean  @default(false) @map("is_customer")
  hasOpenPipeline    Boolean  @default(false) @map("has_open_pipeline")
  createdAt          DateTime @default(now()) @map("created_at")

  @@index([stateAbbrev])
  @@map("unmatched_accounts")
}

model DataRefreshLog {
  id             Int      @id @default(autoincrement())
  dataSource     String   @map("data_source") @db.VarChar(50)
  dataYear       Int?     @map("data_year")
  recordsUpdated Int      @map("records_updated")
  recordsFailed  Int      @default(0) @map("records_failed")
  status         String   @db.VarChar(20)
  errorMessage   String?  @map("error_message")
  startedAt      DateTime @map("started_at")
  completedAt    DateTime @default(now()) @map("completed_at")

  @@index([dataSource, completedAt])
  @@map("data_refresh_logs")
}

// State table - groups districts by state with denormalized aggregates
// Aggregates are refreshed from district data via ETL
model State {
  fips   String @id @db.VarChar(2) // "06" for California
  abbrev String @unique @db.VarChar(2) // "CA"
  name   String @db.VarChar(100) // "California"

  // ===== Denormalized Aggregates =====
  // Refreshed from districts table via ETL
  totalDistricts     Int      @default(0) @map("total_districts")
  totalEnrollment    Int?     @map("total_enrollment")
  totalSchools       Int?     @map("total_schools")
  totalCustomers     Int      @default(0) @map("total_customers")
  totalWithPipeline  Int      @default(0) @map("total_with_pipeline")
  totalPipelineValue Decimal? @map("total_pipeline_value") @db.Decimal(15, 2)

  // Education averages (weighted by enrollment where appropriate)
  avgExpenditurePerPupil Decimal? @map("avg_expenditure_per_pupil") @db.Decimal(12, 2)
  avgGraduationRate      Decimal? @map("avg_graduation_rate") @db.Decimal(5, 2)
  avgPovertyRate         Decimal? @map("avg_poverty_rate") @db.Decimal(5, 2)

  // ===== Territory Management =====
  territoryOwner String? @map("territory_owner") @db.VarChar(100)
  notes          String?

  // ===== Timestamps =====
  aggregatesUpdatedAt DateTime? @map("aggregates_updated_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // ===== Relations =====
  districts      District[]
  territoryPlans TerritoryPlan[]

  @@map("states")
}

model TerritoryPlan {
  id          String    @id @default(uuid())
  name        String    @db.VarChar(255)
  description String?
  owner       String?   @db.VarChar(100)
  color       String    @default("#403770") @db.VarChar(7)
  status      String    @default("active") @db.VarChar(20)
  fiscalYear  Int       @map("fiscal_year") // Required: 2025, 2026, 2027, etc.
  startDate   DateTime? @map("start_date")
  endDate     DateTime? @map("end_date")
  userId      String?   @map("user_id") @db.Uuid
  stateFips   String?   @map("state_fips") @db.VarChar(2) // Optional state association
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  districts  TerritoryPlanDistrict[]
  activities PlanActivity[]
  state      State?                  @relation(fields: [stateFips], references: [fips])

  @@index([userId])
  @@index([userId, fiscalYear])
  @@index([stateFips])
  @@map("territory_plans")
}

model TerritoryPlanDistrict {
  planId        String   @map("plan_id")
  districtLeaid String   @map("district_leaid") @db.VarChar(7)
  addedAt       DateTime @default(now()) @map("added_at")

  // Per-district targets
  revenueTarget  Decimal? @map("revenue_target") @db.Decimal(15, 2)
  pipelineTarget Decimal? @map("pipeline_target") @db.Decimal(15, 2)
  notes          String?

  // Relations
  district       District                       @relation(fields: [districtLeaid], references: [leaid])
  plan           TerritoryPlan                  @relation(fields: [planId], references: [id], onDelete: Cascade)
  targetServices TerritoryPlanDistrictService[]

  @@id([planId, districtLeaid])
  @@map("territory_plan_districts")
}

// ===== Plan Activities =====
// Tracks sales activities (visits, emails, meetings, etc.) for territory plans

model PlanActivity {
  id            String   @id @default(uuid())
  planId        String   @map("plan_id")
  districtLeaid String?  @map("district_leaid") @db.VarChar(7) // null = plan-level activity
  type          String   @db.VarChar(30) // email_campaign, in_person_visit, sales_meeting, conference, phone_call
  title         String   @db.VarChar(255)
  notes         String?
  activityDate  DateTime @map("activity_date")
  status        String   @default("planned") @db.VarChar(20) // planned, completed, cancelled
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  plan     TerritoryPlan         @relation(fields: [planId], references: [id], onDelete: Cascade)
  district District?             @relation(fields: [districtLeaid], references: [leaid])
  contacts PlanActivityContact[]

  @@index([planId])
  @@index([planId, activityDate])
  @@map("plan_activities")
}

// Junction table for linking activities to contacts
model PlanActivityContact {
  activityId String       @map("activity_id")
  contactId  Int          @map("contact_id")
  activity   PlanActivity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  contact    Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@id([activityId, contactId])
  @@map("plan_activity_contacts")
}

// ===== User Profile & Goals =====
// User profile - synced from Supabase Auth on login
// Stores user preferences and tracks whether they've completed the initial setup wizard
model UserProfile {
  id                String    @id @db.Uuid // Supabase user.id
  email             String    @unique @db.VarChar(255)
  fullName          String?   @map("full_name") @db.VarChar(255)
  avatarUrl         String?   @map("avatar_url") @db.VarChar(500)
  hasCompletedSetup Boolean   @default(false) @map("has_completed_setup")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  lastLoginAt       DateTime? @map("last_login_at")

  // Relation to user's fiscal year goals
  goals UserGoal[]

  @@map("user_profiles")
}

// ===== Service Catalog =====
// Fullmind's service offerings that can be targeted for districts
model Service {
  id        Int    @id @default(autoincrement())
  name      String @unique @db.VarChar(100)
  slug      String @unique @db.VarChar(50)
  color     String @db.VarChar(7)
  sortOrder Int    @default(0) @map("sort_order")

  planDistrictServices TerritoryPlanDistrictService[]

  @@map("services")
}

// Junction table linking plan-districts to target services
model TerritoryPlanDistrictService {
  planId        String @map("plan_id")
  districtLeaid String @map("district_leaid") @db.VarChar(7)
  serviceId     Int    @map("service_id")

  planDistrict TerritoryPlanDistrict @relation(fields: [planId, districtLeaid], references: [planId, districtLeaid], onDelete: Cascade)
  service      Service               @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@id([planId, districtLeaid, serviceId])
  @@map("territory_plan_district_services")
}

// User goals by fiscal year - tracks revenue, margin, pipeline, and new district targets
// One row per user per fiscal year (e.g., FY26, FY27)
model UserGoal {
  id         Int    @id @default(autoincrement())
  userId     String @map("user_id") @db.Uuid
  fiscalYear Int    @map("fiscal_year") // 2025, 2026, 2027

  // Target values - all optional since users may only set some goals
  revenueTarget      Decimal? @map("revenue_target") @db.Decimal(15, 2)
  takeTarget         Decimal? @map("take_target") @db.Decimal(15, 2) // Gross margin/take
  pipelineTarget     Decimal? @map("pipeline_target") @db.Decimal(15, 2)
  newDistrictsTarget Int?     @map("new_districts_target")
  earningsTarget     Decimal? @map("earnings_target") @db.Decimal(15, 2) // Total earnings goal

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relation to user profile
  user UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, fiscalYear]) // One goal record per user per fiscal year
  @@index([userId])
  @@map("user_goals")
}
