generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [postgis]
}

// Main district table - consolidated from multiple tables for simpler queries
// Contains: core district info, Fullmind CRM data, education data, demographics, and user edits
model District {
  leaid              String   @id @db.VarChar(7)
  name               String   @db.VarChar(255)
  stateFips          String   @map("state_fips") @db.VarChar(2)
  stateAbbrev        String?  @map("state_abbrev") @db.VarChar(2)
  mtfcc              String?  @db.VarChar(5)
  sdtyp              String?  @db.VarChar(1)
  funcstat           String?  @default("E") @db.VarChar(1)
  lograde            String?  @db.VarChar(2)
  higrade            String?  @db.VarChar(2)
  enrollment         Int?
  urbanInstituteYear Int?     @map("urban_institute_year")
  phone              String?  @db.VarChar(20)
  streetLocation     String?  @map("street_location") @db.VarChar(255)
  cityLocation       String?  @map("city_location") @db.VarChar(100)
  stateLocation      String?  @map("state_location") @db.VarChar(2)
  zipLocation        String?  @map("zip_location") @db.VarChar(10)
  countyName         String?  @map("county_name") @db.VarChar(100)
  urbanCentricLocale Int?     @map("urban_centric_locale")
  numberOfSchools    Int?     @map("number_of_schools")
  specEdStudents     Int?     @map("spec_ed_students")
  ellStudents        Int?     @map("ell_students")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // ===== Fullmind CRM Data =====
  // Source: Fullmind CSV import via ETL
  accountName              String?  @map("account_name") @db.VarChar(255)
  salesExecutive           String?  @map("sales_executive") @db.VarChar(100)
  lmsid                    String?  @db.VarChar(50)
  // FY25 Sessions
  fy25SessionsRevenue      Decimal? @default(0) @map("fy25_sessions_revenue") @db.Decimal(15, 2)
  fy25SessionsTake         Decimal? @default(0) @map("fy25_sessions_take") @db.Decimal(15, 2)
  fy25SessionsCount        Int?     @default(0) @map("fy25_sessions_count")
  // FY26 Sessions
  fy26SessionsRevenue      Decimal? @default(0) @map("fy26_sessions_revenue") @db.Decimal(15, 2)
  fy26SessionsTake         Decimal? @default(0) @map("fy26_sessions_take") @db.Decimal(15, 2)
  fy26SessionsCount        Int?     @default(0) @map("fy26_sessions_count")
  // FY25 Bookings
  fy25ClosedWonOppCount    Int?     @default(0) @map("fy25_closed_won_opp_count")
  fy25ClosedWonNetBooking  Decimal? @default(0) @map("fy25_closed_won_net_booking") @db.Decimal(15, 2)
  fy25NetInvoicing         Decimal? @default(0) @map("fy25_net_invoicing") @db.Decimal(15, 2)
  // FY26 Bookings
  fy26ClosedWonOppCount    Int?     @default(0) @map("fy26_closed_won_opp_count")
  fy26ClosedWonNetBooking  Decimal? @default(0) @map("fy26_closed_won_net_booking") @db.Decimal(15, 2)
  fy26NetInvoicing         Decimal? @default(0) @map("fy26_net_invoicing") @db.Decimal(15, 2)
  // FY26 Pipeline
  fy26OpenPipelineOppCount Int?     @default(0) @map("fy26_open_pipeline_opp_count")
  fy26OpenPipeline         Decimal? @default(0) @map("fy26_open_pipeline") @db.Decimal(15, 2)
  fy26OpenPipelineWeighted Decimal? @default(0) @map("fy26_open_pipeline_weighted") @db.Decimal(15, 2)
  // FY27 Pipeline
  fy27OpenPipelineOppCount Int?     @default(0) @map("fy27_open_pipeline_opp_count")
  fy27OpenPipeline         Decimal? @default(0) @map("fy27_open_pipeline") @db.Decimal(15, 2)
  fy27OpenPipelineWeighted Decimal? @default(0) @map("fy27_open_pipeline_weighted") @db.Decimal(15, 2)
  // Computed flags
  isCustomer               Boolean? @default(false) @map("is_customer")
  hasOpenPipeline          Boolean? @default(false) @map("has_open_pipeline")

  // ===== Finance Data =====
  // Source: Urban Institute API (finance endpoint)
  totalRevenue        Decimal? @map("total_revenue") @db.Decimal(15, 2)
  federalRevenue      Decimal? @map("federal_revenue") @db.Decimal(15, 2)
  stateRevenue        Decimal? @map("state_revenue") @db.Decimal(15, 2)
  localRevenue        Decimal? @map("local_revenue") @db.Decimal(15, 2)
  totalExpenditure    Decimal? @map("total_expenditure") @db.Decimal(15, 2)
  expenditurePerPupil Decimal? @map("expenditure_per_pupil") @db.Decimal(12, 2)
  financeDataYear     Int?     @map("finance_data_year")

  // ===== Poverty Data =====
  // Source: Urban Institute API (SAIPE endpoint)
  childrenPovertyCount   Int?     @map("children_poverty_count")
  childrenPovertyPercent Decimal? @map("children_poverty_percent") @db.Decimal(5, 2)
  medianHouseholdIncome  Decimal? @map("median_household_income") @db.Decimal(12, 2)
  saipeDataYear          Int?     @map("saipe_data_year")

  // ===== Graduation Data =====
  // Source: Urban Institute API (graduation endpoint)
  graduationRateTotal  Decimal? @map("graduation_rate_total") @db.Decimal(5, 2)
  graduationDataYear   Int?     @map("graduation_data_year")

  // ===== Staffing & Salaries =====
  // Source: Urban Institute API (staff endpoint)
  salariesTotal                Decimal? @map("salaries_total") @db.Decimal(15, 2)
  salariesInstruction          Decimal? @map("salaries_instruction") @db.Decimal(15, 2)
  salariesTeachersRegular      Decimal? @map("salaries_teachers_regular") @db.Decimal(15, 2)
  salariesTeachersSpecialEd    Decimal? @map("salaries_teachers_special_ed") @db.Decimal(15, 2)
  salariesTeachersVocational   Decimal? @map("salaries_teachers_vocational") @db.Decimal(15, 2)
  salariesTeachersOther        Decimal? @map("salaries_teachers_other") @db.Decimal(15, 2)
  salariesSupportAdmin         Decimal? @map("salaries_support_admin") @db.Decimal(15, 2)
  salariesSupportInstructional Decimal? @map("salaries_support_instructional") @db.Decimal(15, 2)
  benefitsTotal                Decimal? @map("benefits_total") @db.Decimal(15, 2)
  teachersFte                  Decimal? @map("teachers_fte") @db.Decimal(10, 2)
  teachersElementaryFte        Decimal? @map("teachers_elementary_fte") @db.Decimal(10, 2)
  teachersSecondaryFte         Decimal? @map("teachers_secondary_fte") @db.Decimal(10, 2)
  adminFte                     Decimal? @map("admin_fte") @db.Decimal(10, 2)
  guidanceCounselorsFte        Decimal? @map("guidance_counselors_fte") @db.Decimal(10, 2)
  instructionalAidesFte        Decimal? @map("instructional_aides_fte") @db.Decimal(10, 2)
  supportStaffFte              Decimal? @map("support_staff_fte") @db.Decimal(10, 2)
  staffTotalFte                Decimal? @map("staff_total_fte") @db.Decimal(10, 2)
  staffDataYear                Int?     @map("staff_data_year")

  // ===== Absenteeism Data =====
  // Source: Urban Institute API (chronic absenteeism endpoint)
  chronicAbsenteeismCount Int?     @map("chronic_absenteeism_count")
  chronicAbsenteeismRate  Decimal? @map("chronic_absenteeism_rate") @db.Decimal(5, 2)
  absenteeismDataYear     Int?     @map("absenteeism_data_year")

  // ===== Demographics =====
  // Source: Urban Institute API (enrollment endpoint)
  enrollmentWhite           Int? @map("enrollment_white")
  enrollmentBlack           Int? @map("enrollment_black")
  enrollmentHispanic        Int? @map("enrollment_hispanic")
  enrollmentAsian           Int? @map("enrollment_asian")
  enrollmentAmericanIndian  Int? @map("enrollment_american_indian")
  enrollmentPacificIslander Int? @map("enrollment_pacific_islander")
  enrollmentTwoOrMore       Int? @map("enrollment_two_or_more")
  totalEnrollment           Int? @map("total_enrollment")
  demographicsDataYear      Int? @map("demographics_data_year")

  // ===== External Links =====
  // Source: District links CSV via ETL
  websiteUrl  String? @map("website_url") @db.VarChar(255)
  jobBoardUrl String? @map("job_board_url") @db.VarChar(1000)

  // ===== User Edits =====
  // Source: App users (shared across team)
  notes          String?
  owner          String?   @db.VarChar(100)
  notesUpdatedAt DateTime? @map("notes_updated_at")

  // ===== PostGIS Geometry (managed outside Prisma) =====
  geometry Unsupported("geometry(MultiPolygon, 4326)")?
  centroid Unsupported("geometry(Point, 4326)")?

  // ===== Charter School Aggregates =====
  // Cached from schools table via ETL post-processing
  charterSchoolCount Int? @map("charter_school_count")
  charterEnrollment  Int? @map("charter_enrollment")

  // ===== Staffing Ratios (computed post-ETL) =====
  // Computed from enrollment and FTE data after ETL runs
  studentTeacherRatio     Decimal? @map("student_teacher_ratio") @db.Decimal(8, 2)
  studentStaffRatio       Decimal? @map("student_staff_ratio") @db.Decimal(8, 2)
  spedStudentTeacherRatio Decimal? @map("sped_student_teacher_ratio") @db.Decimal(8, 2)

  // ===== Special Education Finance =====
  // Source: Urban Institute API (finance endpoint) - sped expenditure detail
  spedExpenditureTotal       Decimal? @map("sped_expenditure_total") @db.Decimal(15, 2)
  spedExpenditureInstruction Decimal? @map("sped_expenditure_instruction") @db.Decimal(15, 2)
  spedExpenditureSupport     Decimal? @map("sped_expenditure_support") @db.Decimal(15, 2)
  spedExpenditurePerStudent  Decimal? @map("sped_expenditure_per_student") @db.Decimal(12, 2)

  // ===== ESSER / COVID Relief Funding =====
  // Source: Urban Institute API (finance endpoint) - federal COVID relief
  esserFundingTotal    Decimal? @map("esser_funding_total") @db.Decimal(15, 2)
  esserSpendingTotal   Decimal? @map("esser_spending_total") @db.Decimal(15, 2)
  esserSpendingInstruction Decimal? @map("esser_spending_instruction") @db.Decimal(15, 2)

  // ===== Assessment Data =====
  // Source: Urban Institute API (EdFacts assessments endpoint)
  mathProficiencyPct  Decimal? @map("math_proficiency_pct") @db.Decimal(5, 2)
  readProficiencyPct  Decimal? @map("read_proficiency_pct") @db.Decimal(5, 2)
  assessmentDataYear  Int?     @map("assessment_data_year")

  // ===== Technology & Capital Spending =====
  // Source: Urban Institute API (finance endpoint)
  techSpending       Decimal? @map("tech_spending") @db.Decimal(15, 2)
  capitalOutlayTotal Decimal? @map("capital_outlay_total") @db.Decimal(15, 2)
  debtOutstanding    Decimal? @map("debt_outstanding") @db.Decimal(15, 2)

  // ===== Outsourcing Signals =====
  // Source: Urban Institute API (finance endpoint) - districts paying external providers
  paymentsToCharterSchools  Decimal? @map("payments_to_charter_schools") @db.Decimal(15, 2)
  paymentsToPrivateSchools  Decimal? @map("payments_to_private_schools") @db.Decimal(15, 2)

  // ===== Trend Signals (computed after historical backfill) =====
  enrollmentTrend3yr       Decimal? @map("enrollment_trend_3yr") @db.Decimal(8, 2)
  staffingTrend3yr         Decimal? @map("staffing_trend_3yr") @db.Decimal(8, 2)
  vacancyPressureSignal    Decimal? @map("vacancy_pressure_signal") @db.Decimal(8, 2)

  // ===== Relations =====
  state           State?                  @relation(fields: [stateFips], references: [fips])
  contacts        Contact[]
  districtTags    DistrictTag[]
  territoryPlans  TerritoryPlanDistrict[]
  competitorSpend CompetitorSpend[]
  activityLinks   ActivityDistrict[]
  taskLinks       TaskDistrict[]
  schools         School[]
  dataHistory     DistrictDataHistory[]
  gradeEnrollment DistrictGradeEnrollment[]

  @@index([stateFips])
  @@index([isCustomer, hasOpenPipeline])
  @@index([stateAbbrev])
  @@index([stateAbbrev, isCustomer])
  @@index([stateAbbrev, hasOpenPipeline])
  @@index([salesExecutive])
  @@index([studentTeacherRatio])
  @@index([vacancyPressureSignal])
  @@map("districts")
}

model Tag {
  id           Int           @id @default(autoincrement())
  name         String        @unique @db.VarChar(50)
  color        String        @db.VarChar(7)
  districtTags DistrictTag[]
  schoolTags   SchoolTag[]

  @@map("tags")
}

model DistrictTag {
  districtLeaid String   @map("district_leaid") @db.VarChar(7)
  tagId         Int      @map("tag_id")
  district      District @relation(fields: [districtLeaid], references: [leaid])
  tag           Tag      @relation(fields: [tagId], references: [id])

  @@id([districtLeaid, tagId])
  @@map("district_tags")
}

// ===== Competitor Spend =====
// Tracks competitor purchase order spend by district, competitor, and fiscal year
// Source: GovSpend PO data via ETL
model CompetitorSpend {
  id          Int      @id @default(autoincrement())
  leaid       String   @db.VarChar(7)
  competitor  String   @db.VarChar(50)
  fiscalYear  String   @map("fiscal_year") @db.VarChar(4)
  totalSpend  Decimal  @map("total_spend") @db.Decimal(12, 2)
  poCount     Int      @map("po_count")
  lastUpdated DateTime @default(now()) @map("last_updated")

  district District @relation(fields: [leaid], references: [leaid])

  @@unique([leaid, competitor, fiscalYear])
  @@index([leaid])
  @@index([competitor, fiscalYear])
  @@map("competitor_spend")
}

model Contact {
  id             Int               @id @default(autoincrement())
  leaid          String            @db.VarChar(7)
  salutation     String?           @db.VarChar(20)
  name           String            @db.VarChar(255)
  title          String?           @db.VarChar(255)
  email          String?           @db.VarChar(255)
  phone          String?           @db.VarChar(50)
  isPrimary      Boolean           @default(false) @map("is_primary")
  linkedinUrl    String?           @map("linkedin_url") @db.VarChar(500)
  persona        String?           @db.VarChar(100)
  seniorityLevel String?           @map("seniority_level") @db.VarChar(100)
  createdAt      DateTime          @default(now()) @map("created_at")
  lastEnrichedAt DateTime?         @map("last_enriched_at")
  district       District          @relation(fields: [leaid], references: [leaid])
  activityLinks  ActivityContact[]
  taskLinks      TaskContact[]
  schoolContacts SchoolContact[]

  @@index([leaid])
  @@map("contacts")
}

model UnmatchedAccount {
  id                 Int      @id @default(autoincrement())
  accountName        String   @map("account_name") @db.VarChar(255)
  salesExecutive     String?  @map("sales_executive") @db.VarChar(100)
  stateAbbrev        String   @map("state_abbrev") @db.VarChar(2)
  lmsid              String?  @db.VarChar(50)
  leaidRaw           String?  @map("leaid_raw") @db.VarChar(50)
  matchFailureReason String   @map("match_failure_reason") @db.VarChar(100)
  fy25NetInvoicing   Decimal  @default(0) @map("fy25_net_invoicing") @db.Decimal(15, 2)
  fy26NetInvoicing   Decimal  @default(0) @map("fy26_net_invoicing") @db.Decimal(15, 2)
  fy26OpenPipeline   Decimal  @default(0) @map("fy26_open_pipeline") @db.Decimal(15, 2)
  fy27OpenPipeline   Decimal  @default(0) @map("fy27_open_pipeline") @db.Decimal(15, 2)
  isCustomer         Boolean  @default(false) @map("is_customer")
  hasOpenPipeline    Boolean  @default(false) @map("has_open_pipeline")
  createdAt          DateTime @default(now()) @map("created_at")

  @@index([stateAbbrev])
  @@map("unmatched_accounts")
}

model DataRefreshLog {
  id             Int      @id @default(autoincrement())
  dataSource     String   @map("data_source") @db.VarChar(50)
  dataYear       Int?     @map("data_year")
  recordsUpdated Int      @map("records_updated")
  recordsFailed  Int      @default(0) @map("records_failed")
  status         String   @db.VarChar(20)
  errorMessage   String?  @map("error_message")
  startedAt      DateTime @map("started_at")
  completedAt    DateTime @default(now()) @map("completed_at")

  @@index([dataSource, completedAt])
  @@map("data_refresh_logs")
}

// State table - groups districts by state with denormalized aggregates
// Aggregates are refreshed from district data via ETL
model State {
  fips   String @id @db.VarChar(2) // "06" for California
  abbrev String @unique @db.VarChar(2) // "CA"
  name   String @db.VarChar(100) // "California"

  // ===== Denormalized Aggregates =====
  // Refreshed from districts table via ETL
  totalDistricts     Int      @default(0) @map("total_districts")
  totalEnrollment    Int?     @map("total_enrollment")
  totalSchools       Int?     @map("total_schools")
  totalCustomers     Int      @default(0) @map("total_customers")
  totalWithPipeline  Int      @default(0) @map("total_with_pipeline")
  totalPipelineValue Decimal? @map("total_pipeline_value") @db.Decimal(15, 2)

  // Education averages (weighted by enrollment where appropriate)
  avgExpenditurePerPupil Decimal? @map("avg_expenditure_per_pupil") @db.Decimal(12, 2)
  avgGraduationRate      Decimal? @map("avg_graduation_rate") @db.Decimal(5, 2)
  avgPovertyRate         Decimal? @map("avg_poverty_rate") @db.Decimal(5, 2)
  avgChronicAbsenteeismRate Decimal? @map("avg_chronic_absenteeism_rate") @db.Decimal(5, 2)
  avgStudentTeacherRatio    Decimal? @map("avg_student_teacher_ratio") @db.Decimal(8, 2)
  avgSwdPct                 Decimal? @map("avg_swd_pct") @db.Decimal(5, 2)
  avgEllPct                 Decimal? @map("avg_ell_pct") @db.Decimal(5, 2)
  avgEnrollment             Int?     @map("avg_enrollment")
  avgMathProficiency        Decimal? @map("avg_math_proficiency") @db.Decimal(5, 2)
  avgReadProficiency        Decimal? @map("avg_read_proficiency") @db.Decimal(5, 2)

  // ===== Territory Management =====
  territoryOwner String? @map("territory_owner") @db.VarChar(100)
  notes          String?

  // ===== Timestamps =====
  aggregatesUpdatedAt DateTime? @map("aggregates_updated_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // ===== Relations =====
  districts      District[]
  territoryPlans TerritoryPlan[]
  activityLinks  ActivityState[]
  assessments    StateAssessment[]

  @@map("states")
}

// ===== State Assessment Programs =====
// Reference table: which standardized tests each state administers
// One row per assessment program per state (e.g., PA has PSSA + Keystone)
// ~80-100 rows total, updated ~once per year when states change programs
model StateAssessment {
  id            Int      @id @default(autoincrement())
  stateFips     String   @map("state_fips") @db.VarChar(2)
  name          String   @db.VarChar(150)
  subjects      String   @db.VarChar(255)
  grades        String   @db.VarChar(100)
  testingWindow String   @map("testing_window") @db.VarChar(255)
  vendor        String?  @db.VarChar(150)
  notes         String?
  updatedAt     DateTime @updatedAt @map("updated_at")

  state State @relation(fields: [stateFips], references: [fips])

  @@unique([stateFips, name])
  @@index([stateFips])
  @@map("state_assessments")
}

model TerritoryPlan {
  id          String    @id @default(uuid())
  name        String    @db.VarChar(255)
  description String?
  owner       String?   @db.VarChar(100)
  color       String    @default("#403770") @db.VarChar(7)
  status      String    @default("active") @db.VarChar(20)
  fiscalYear  Int       @map("fiscal_year") // Required: 2025, 2026, 2027, etc.
  startDate   DateTime? @map("start_date")
  endDate     DateTime? @map("end_date")
  userId      String?   @map("user_id") @db.Uuid
  stateFips   String?   @map("state_fips") @db.VarChar(2) // Optional state association
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  districts     TerritoryPlanDistrict[]
  state         State?                  @relation(fields: [stateFips], references: [fips])
  activityLinks ActivityPlan[]
  taskLinks     TaskPlan[]

  @@index([userId])
  @@index([userId, fiscalYear])
  @@index([stateFips])
  @@map("territory_plans")
}

model TerritoryPlanDistrict {
  planId        String   @map("plan_id")
  districtLeaid String   @map("district_leaid") @db.VarChar(7)
  addedAt       DateTime @default(now()) @map("added_at")

  // Per-district targets
  revenueTarget  Decimal? @map("revenue_target") @db.Decimal(15, 2)
  pipelineTarget Decimal? @map("pipeline_target") @db.Decimal(15, 2)
  notes          String?

  // Relations
  district       District                       @relation(fields: [districtLeaid], references: [leaid])
  plan           TerritoryPlan                  @relation(fields: [planId], references: [id], onDelete: Cascade)
  targetServices TerritoryPlanDistrictService[]

  @@id([planId, districtLeaid])
  @@map("territory_plan_districts")
}

// ===== Activities System =====
// Replaces PlanActivity - activities can now link to multiple plans, districts, contacts, states

model Activity {
  id              String    @id @default(uuid())
  type            String    @db.VarChar(30) // conference, road_trip, email_campaign, etc.
  title           String    @db.VarChar(255)
  notes           String?
  startDate       DateTime? @map("start_date")
  endDate         DateTime? @map("end_date")
  status          String    @default("planned") @db.VarChar(20) // planned, completed, cancelled
  createdByUserId String?   @map("created_by_user_id") @db.Uuid
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // ===== Calendar Sync Fields =====
  // Links activity to a Google Calendar event for two-way sync
  googleEventId String? @unique @map("google_event_id")
  // Tracks whether this activity was created manually or pulled from calendar
  source        String  @default("manual") @db.VarChar(20) // manual, calendar_sync

  // ===== Outcome Tracking =====
  // Captures what resulted from the activity (set on completion)
  outcome     String? @db.VarChar(500) // free-text outcome note
  outcomeType String? @map("outcome_type") @db.VarChar(30) // positive_progress, neutral, negative, follow_up_needed, etc.

  // Relations (all many-to-many via junction tables)
  plans     ActivityPlan[]
  districts ActivityDistrict[]
  contacts  ActivityContact[]
  states    ActivityState[]
  taskLinks TaskActivity[]

  @@index([createdByUserId])
  @@index([type])
  @@index([startDate])
  @@map("activities")
}

model ActivityPlan {
  activityId String        @map("activity_id")
  planId     String        @map("plan_id")
  activity   Activity      @relation(fields: [activityId], references: [id], onDelete: Cascade)
  plan       TerritoryPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@id([activityId, planId])
  @@index([planId]) // Speed up lookups by plan
  @@map("activity_plans")
}

model ActivityDistrict {
  activityId       String   @map("activity_id")
  districtLeaid    String   @map("district_leaid") @db.VarChar(7)
  warningDismissed Boolean  @default(false) @map("warning_dismissed")
  activity         Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  district         District @relation(fields: [districtLeaid], references: [leaid], onDelete: Cascade)

  @@id([activityId, districtLeaid])
  @@index([districtLeaid]) // Speed up lookups by district
  @@map("activity_districts")
}

model ActivityContact {
  activityId String   @map("activity_id")
  contactId  Int      @map("contact_id")
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  contact    Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@id([activityId, contactId])
  @@map("activity_contacts")
}

model ActivityState {
  activityId String   @map("activity_id")
  stateFips  String   @map("state_fips") @db.VarChar(2)
  isExplicit Boolean  @default(false) @map("is_explicit")
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  state      State    @relation(fields: [stateFips], references: [fips], onDelete: Cascade)

  @@id([activityId, stateFips])
  @@index([stateFips]) // Speed up lookups by state
  @@map("activity_states")
}

// ===== User Profile & Goals =====
// User profile - synced from Supabase Auth on login
// Stores user preferences and tracks whether they've completed the initial setup wizard
model UserProfile {
  id                String    @id @db.Uuid // Supabase user.id
  email             String    @unique @db.VarChar(255)
  fullName          String?   @map("full_name") @db.VarChar(255)
  avatarUrl         String?   @map("avatar_url") @db.VarChar(500)
  hasCompletedSetup Boolean   @default(false) @map("has_completed_setup")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  lastLoginAt       DateTime? @map("last_login_at")

  // Relation to user's fiscal year goals
  goals              UserGoal[]
  // Relation to Google Calendar connection (one per user)
  calendarConnection CalendarConnection?

  @@map("user_profiles")
}

// ===== Service Catalog =====
// Fullmind's service offerings that can be targeted for districts
model Service {
  id        Int    @id @default(autoincrement())
  name      String @unique @db.VarChar(100)
  slug      String @unique @db.VarChar(50)
  color     String @db.VarChar(7)
  sortOrder Int    @default(0) @map("sort_order")

  planDistrictServices TerritoryPlanDistrictService[]

  @@map("services")
}

// Junction table linking plan-districts to target services
model TerritoryPlanDistrictService {
  planId        String @map("plan_id")
  districtLeaid String @map("district_leaid") @db.VarChar(7)
  serviceId     Int    @map("service_id")

  planDistrict TerritoryPlanDistrict @relation(fields: [planId, districtLeaid], references: [planId, districtLeaid], onDelete: Cascade)
  service      Service               @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@id([planId, districtLeaid, serviceId])
  @@map("territory_plan_district_services")
}

// User goals by fiscal year - tracks revenue, margin, pipeline, and new district targets
// One row per user per fiscal year (e.g., FY26, FY27)
model UserGoal {
  id         Int    @id @default(autoincrement())
  userId     String @map("user_id") @db.Uuid
  fiscalYear Int    @map("fiscal_year") // 2025, 2026, 2027

  // Target values - all optional since users may only set some goals
  earningsTarget     Decimal? @map("earnings_target") @db.Decimal(15, 2) // Total earnings goal (user input)
  takeRatePercent    Decimal? @map("take_rate_percent") @db.Decimal(5, 2) // Expected take rate % (user input)
  // Calculated goals based on earnings and take rate
  revenueTarget      Decimal? @map("revenue_target") @db.Decimal(15, 2)
  takeTarget         Decimal? @map("take_target") @db.Decimal(15, 2) // Gross margin/take
  pipelineTarget     Decimal? @map("pipeline_target") @db.Decimal(15, 2)
  newDistrictsTarget Int?     @map("new_districts_target")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relation to user profile
  user UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, fiscalYear]) // One goal record per user per fiscal year
  @@index([userId])
  @@map("user_goals")
}

// ===== Task Tracking System =====
// Tasks can be standalone or linked to any combination of districts, plans, activities, and contacts
// Supports kanban board workflow with drag-and-drop reordering

model Task {
  id              String    @id @default(uuid())
  title           String    @db.VarChar(255)
  description     String?
  status          String    @default("todo") @db.VarChar(20) // todo, in_progress, blocked, done
  priority        String    @default("medium") @db.VarChar(10) // low, medium, high, urgent
  dueDate         DateTime? @map("due_date")
  position        Int       @default(0) // ordering within kanban column
  createdByUserId String    @map("created_by_user_id") @db.Uuid
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations (all many-to-many via junction tables)
  districts  TaskDistrict[]
  plans      TaskPlan[]
  activities TaskActivity[]
  contacts   TaskContact[]

  @@index([createdByUserId])
  @@index([status])
  @@index([dueDate])
  @@map("tasks")
}

model TaskDistrict {
  taskId        String   @map("task_id")
  districtLeaid String   @map("district_leaid") @db.VarChar(7)
  task          Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  district      District @relation(fields: [districtLeaid], references: [leaid], onDelete: Cascade)

  @@id([taskId, districtLeaid])
  @@index([districtLeaid])
  @@map("task_districts")
}

model TaskPlan {
  taskId String        @map("task_id")
  planId String        @map("plan_id")
  task   Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)
  plan   TerritoryPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@id([taskId, planId])
  @@index([planId])
  @@map("task_plans")
}

model TaskActivity {
  taskId     String   @map("task_id")
  activityId String   @map("activity_id")
  task       Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@id([taskId, activityId])
  @@index([activityId])
  @@map("task_activities")
}

model TaskContact {
  taskId    String  @map("task_id")
  contactId Int     @map("contact_id")
  task      Task    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@id([taskId, contactId])
  @@index([contactId])
  @@map("task_contacts")
}

// ===== Google Calendar Integration =====
// Stores OAuth tokens for a user's Google Calendar connection
// One connection per user — enables two-way sync between activities and calendar events

model CalendarConnection {
  id                 String    @id @default(uuid())
  userId             String    @unique @map("user_id") @db.Uuid
  googleAccountEmail String    @map("google_account_email") @db.VarChar(255)
  accessToken        String    @map("access_token") // encrypted at rest
  refreshToken       String    @map("refresh_token") // encrypted at rest
  tokenExpiresAt     DateTime  @map("token_expires_at")
  companyDomain      String    @map("company_domain") @db.VarChar(100) // e.g. "fullmindlearning.com" — filters internal attendees
  syncEnabled        Boolean   @default(true) @map("sync_enabled")
  lastSyncAt         DateTime? @map("last_sync_at")
  status             String    @default("connected") @db.VarChar(20) // connected, disconnected, error
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  // Relations
  user   UserProfile     @relation(fields: [userId], references: [id], onDelete: Cascade)
  events CalendarEvent[]

  @@map("calendar_connections")
}

// ===== Calendar Event Staging =====
// Incoming Google Calendar events land here for rep review before becoming Activities
// Smart matching suggests district/contact/plan associations based on attendee emails

model CalendarEvent {
  id                    String   @id @default(uuid())
  userId                String   @map("user_id") @db.Uuid
  connectionId          String   @map("connection_id")
  googleEventId         String   @map("google_event_id")
  title                 String   @db.VarChar(500)
  description           String?
  startTime             DateTime @map("start_time")
  endTime               DateTime @map("end_time")
  location              String?  @db.VarChar(500)
  attendees             Json     @default("[]") // [{email, name, responseStatus}]
  status                String   @default("pending") @db.VarChar(20) // pending, confirmed, dismissed, cancelled
  suggestedActivityType String?  @map("suggested_activity_type") @db.VarChar(30)
  suggestedDistrictId   String?  @map("suggested_district_id") @db.VarChar(7)
  suggestedContactIds   Json?    @map("suggested_contact_ids") // [contactId, ...]
  suggestedPlanId       String?  @map("suggested_plan_id")
  matchConfidence       String   @default("none") @db.VarChar(10) // high, medium, low, none
  activityId            String?  @map("activity_id") // populated when rep confirms → Activity created
  lastSyncedAt          DateTime @map("last_synced_at")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  connection CalendarConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([connectionId, googleEventId])
  @@index([userId, status])
  @@index([activityId])
  @@map("calendar_events")
}

// ===== Schools =====
// Generic school table — supports charter schools now, traditional public schools later
// Source: Urban Institute Education Data API (school-level CCD endpoints)

model School {
  ncessch          String    @id @db.VarChar(12) // NCES 12-char school ID
  leaid            String    @db.VarChar(7) // Parent district
  schoolName       String    @map("school_name") @db.VarChar(255)
  charter          Int       @default(0) // 0=traditional, 1=charter
  schoolLevel      Int?      @map("school_level") // 1=Primary, 2=Middle, 3=High, 4=Other
  schoolType       Int?      @map("school_type")
  lograde          String?   @db.VarChar(10)
  higrade          String?   @db.VarChar(10)
  schoolStatus     Int?      @map("school_status") // 1=Open, 2=Closed, etc.
  latitude         Decimal?  @db.Decimal(10, 7)
  longitude        Decimal?  @db.Decimal(10, 7)
  streetAddress    String?   @map("street_address") @db.VarChar(255)
  city             String?   @db.VarChar(100)
  stateAbbrev      String?   @map("state_abbrev") @db.VarChar(2)
  zip              String?   @db.VarChar(10)
  countyName       String?   @map("county_name") @db.VarChar(100)
  phone            String?   @db.VarChar(20)
  urbanCentricLocale Int?    @map("urban_centric_locale")
  enrollment       Int?
  directoryDataYear Int?     @map("directory_data_year")

  // ===== Lightweight CRM Fields =====
  owner          String?   @db.VarChar(100)
  notes          String?
  notesUpdatedAt DateTime? @map("notes_updated_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // ===== Relations =====
  district          District                  @relation(fields: [leaid], references: [leaid])
  enrollmentHistory SchoolEnrollmentHistory[]
  schoolTags        SchoolTag[]
  schoolContacts    SchoolContact[]

  @@index([leaid])
  @@index([charter])
  @@index([stateAbbrev])
  @@index([charter, stateAbbrev])
  @@map("schools")
}

model SchoolEnrollmentHistory {
  id        Int    @id @default(autoincrement())
  ncessch   String @db.VarChar(12)
  year      Int
  enrollment Int?

  school School @relation(fields: [ncessch], references: [ncessch], onDelete: Cascade)

  @@unique([ncessch, year])
  @@index([ncessch])
  @@map("school_enrollment_history")
}

model SchoolTag {
  schoolId String @map("school_id") @db.VarChar(12)
  tagId    Int    @map("tag_id")
  school   School @relation(fields: [schoolId], references: [ncessch], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([schoolId, tagId])
  @@map("school_tags")
}

model SchoolContact {
  schoolId  String  @map("school_id") @db.VarChar(12)
  contactId Int     @map("contact_id")
  school    School  @relation(fields: [schoolId], references: [ncessch], onDelete: Cascade)
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@id([schoolId, contactId])
  @@map("school_contacts")
}

// ===== Historical Time-Series Data =====
// Tracks year-over-year changes for trend analysis (staffing pressure, budget changes, etc.)
// One row per (leaid, year, source) — enables multi-year comparisons
model DistrictDataHistory {
  id        Int      @id @default(autoincrement())
  leaid     String   @db.VarChar(7)
  year      Int
  source    String   @db.VarChar(30) // ccd_directory, ccd_finance, saipe, edfacts_grad, edfacts_assess

  // Enrollment & Staffing (for vacancy pressure analysis)
  enrollment      Int?
  teachersFte     Decimal? @map("teachers_fte") @db.Decimal(10, 2)
  staffTotalFte   Decimal? @map("staff_total_fte") @db.Decimal(10, 2)
  specEdStudents  Int?     @map("spec_ed_students")

  // Finance (for budget capacity analysis)
  totalRevenue      Decimal? @map("total_revenue") @db.Decimal(15, 2)
  totalExpenditure  Decimal? @map("total_expenditure") @db.Decimal(15, 2)
  expenditurePp     Decimal? @map("expenditure_pp") @db.Decimal(12, 2)
  federalRevenue    Decimal? @map("federal_revenue") @db.Decimal(15, 2)
  stateRevenue      Decimal? @map("state_revenue") @db.Decimal(15, 2)
  localRevenue      Decimal? @map("local_revenue") @db.Decimal(15, 2)
  spedExpenditure   Decimal? @map("sped_expenditure") @db.Decimal(15, 2)

  // Outcomes
  povertyPct       Decimal? @map("poverty_pct") @db.Decimal(5, 2)
  graduationRate   Decimal? @map("graduation_rate") @db.Decimal(5, 2)
  mathProficiency  Decimal? @map("math_proficiency") @db.Decimal(5, 2)
  readProficiency  Decimal? @map("read_proficiency") @db.Decimal(5, 2)

  createdAt DateTime @default(now()) @map("created_at")

  district District @relation(fields: [leaid], references: [leaid])

  @@unique([leaid, year, source])
  @@index([leaid])
  @@index([year])
  @@index([source])
  @@map("district_data_history")
}

// ===== Grade-Level Enrollment =====
// Enrollment broken down by grade level per district per year
// Enables analysis of grade-mix for staffing product fit
model DistrictGradeEnrollment {
  id         Int    @id @default(autoincrement())
  leaid      String @db.VarChar(7)
  year       Int
  grade      String @db.VarChar(10) // K, 01, 02, ... 12, PK, UG
  enrollment Int?

  district District @relation(fields: [leaid], references: [leaid])

  @@unique([leaid, year, grade])
  @@index([leaid])
  @@index([year])
  @@map("district_grade_enrollment")
}
