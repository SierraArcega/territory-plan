name: Monthly Education Data Refresh

on:
  # Run on the 1st of every month at 2 AM UTC
  schedule:
    - cron: '0 2 1 * *'
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      year:
        description: 'Data year to fetch (e.g., 2022)'
        required: false
        default: '2022'
      data_types:
        description: 'Data types to refresh (comma-separated: finance,poverty,demographics,graduation)'
        required: false
        default: 'finance,poverty,demographics,graduation'

env:
  PYTHON_VERSION: '3.11'

jobs:
  refresh-education-data:
    name: Refresh Education Data
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install psycopg2-binary requests python-dotenv tqdm

      - name: Determine data year
        id: year
        run: |
          # Use input year if provided via workflow_dispatch, otherwise default to 2022
          if [ -n "${{ github.event.inputs.year }}" ]; then
            echo "year=${{ github.event.inputs.year }}" >> $GITHUB_OUTPUT
          else
            echo "year=2022" >> $GITHUB_OUTPUT
          fi

      - name: Determine data types
        id: types
        run: |
          if [ -n "${{ github.event.inputs.data_types }}" ]; then
            echo "types=${{ github.event.inputs.data_types }}" >> $GITHUB_OUTPUT
          else
            echo "types=finance,poverty,demographics,graduation" >> $GITHUB_OUTPUT
          fi

      - name: Run Finance ETL
        if: contains(steps.types.outputs.types, 'finance')
        working-directory: scripts/etl
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Fetching finance data for year ${{ steps.year.outputs.year }}..."
          python -m loaders.urban_institute_finance --year ${{ steps.year.outputs.year }}

      - name: Run Poverty ETL
        if: contains(steps.types.outputs.types, 'poverty')
        working-directory: scripts/etl
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Fetching SAIPE poverty data for year ${{ steps.year.outputs.year }}..."
          python -m loaders.urban_institute_poverty --year ${{ steps.year.outputs.year }}

      - name: Run Demographics ETL
        if: contains(steps.types.outputs.types, 'demographics')
        working-directory: scripts/etl
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Fetching demographics data for year ${{ steps.year.outputs.year }}..."
          python -m loaders.urban_institute_demographics --year ${{ steps.year.outputs.year }}

      - name: Run Graduation ETL
        if: contains(steps.types.outputs.types, 'graduation')
        working-directory: scripts/etl
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Fetching graduation data for year ${{ steps.year.outputs.year }}..."
          python -m loaders.urban_institute_graduation --year ${{ steps.year.outputs.year }}

      - name: Print database stats
        working-directory: scripts/etl
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          python run_etl.py --stats-only

      - name: Create summary
        run: |
          echo "## Education Data Refresh Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Data Year:** ${{ steps.year.outputs.year }}" >> $GITHUB_STEP_SUMMARY
          echo "**Data Types:** ${{ steps.types.outputs.types }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered By:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See job logs for detailed results." >> $GITHUB_STEP_SUMMARY

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: refresh-education-data
    if: failure()
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `[Automated] Education Data Refresh Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            The monthly education data refresh workflow failed.

            **Workflow Run:** [View Details](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})
            **Triggered By:** ${context.eventName}

            Please investigate and manually re-run the workflow if needed.
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['automated', 'data-refresh', 'bug']
            });
